# Clarvi

SystemVerilogによるRISC-Vのシンプルな実装です。性能を維持しつつ、教育用に明快で理解しやすいもになることを意図しています。

これはRV32Iコアです。割り込みや例外の完全なサポートを含む、RISC-V特権仕様v1.9の最小限の実装を提供しています。実装はマシンモードのみであり、不正命令をキャッチする部分的なサポートのみです。また、ユーザレベル仕様v2.1を完全サポートしています。

すべてのRV32Iユーザレベルテストと関連するRV32Iマシンモードテストに合格しています（ただし、ユーザモードや仮想メモリなどのサポートを前提とするテストは除きます）。

特権仕様とは以下のような若干の違いがあります。

- 不正アドレスやアライメントを外れたアドレスへの分岐において、例外は後続のフェッチの際に発生するため、分岐の副作用(JALRなど)はすべて維持されます。
  この点については仕様が曖昧であるため、`ma_fetch` テストは失敗します。
- `timecmp`レジスタはメモリマップではなく CSR として実装されています。そのアドレスは`riscv.svh`にあります。
- デバッグ出力を生成する手段として`dscratch`レジスタが採用されています。

`MACHINE_MODE`を未定義にすることでマシンモードを無効にできます。これにより、すべての特権命令、割り込み、例外、不正命令の処理がサポートされなくなりますが、周波数がかなり増加します。

このプロセッサは6ステージのパイプラインを備えています。これは従来のRISCパイプラインに似ていますが、いくつかの違いがあります。

- 命令フェッチは2ステージであり、オンチップメモリを1サイクル固定レイテンシで使用できます。
- ロードとストアは実行ステージで開始され、ロード結果はメモリアラインメントステージで用意されます。
- ジャンプは実行ステージで計算されます。ブランチの採用は常に3サイクルのペナルティが課さえることを意味します。

## メモリ要件

このコアは、個別の命令ポートとデータポートを持つ汎用メモリインターフェースを持っています。これらのポートは、同じメモリにも異なるメモリにも接続することができます。接続されているメモリに応じて適切に`ADDR_WIDTH`パラメタを設定してください。このアドレスを超えてアクセスするとアクセスフォルトが発生します。これは**ワード**アドレス幅であることに注意してください。メモリバスアドレスはすべてワードアドレスであり、バイトアドレスではありません。

付属の`clarvi_avalon`コンポーネントは、Altera Avalon MM インターフェー スに接続するためのラッパーです。このコンポーネントには`readdatavalid`シグナルがありますが、コアは1サイクル固定レイテンシを持つメモリを想定しています。ただし、メモリバスに競合がある場合は、`wait`シグナルの使用をサポートしています。

より長いレイテンシや可変レイテンシを持つメモリを使用するには、メモリアクセスのレイテンシが1サイクル以上になるような時に処理を待つために、コアが持つ`wait`シグナルを使用するラッパーコンポーネントを作成しなければなりません。この`wait`シグナルは Avalon MM の`waitrequest`シグナルのように動作することが期待されます。

## パフォーマンス

メモリとしてオンチップBRAMを使用するCyclone Vボードでは、RAMの量とマシンモードの採用の有無により、100～150Mhzを達成することができます。

CPIは以下の通りです。

- 4: 分岐実行
- 2: 結果に依存する命令が続くロード
- 1: その他すべての命令

それゆえ、どれだけコードに分岐があるかによりますが、平均CPIはおおよそ1.5です。


## ファイルの説明

このリポジトリには以下が含まれています。

### メインソースファイル

- CPUのソースコードは`clarvi.sv`にあります。これには様々な構造体、列挙型、定数を定義している`riscv.svh`が含まれています。
- テストベンチのコードは`sim.sv`にあります。これは同梱のデュアルポートオンチップメモリのモックアップを提供する`bram`テストベンチコンポーネントに依存しています。

### ソフトウェアとテスト

makefile、リンカスクリプト、`init`プログラムが提供されています。ソフトウェアは、ModelSim がサポートする`.mem.txt`ファイルと、Altera Quartus/Qsys がサポートする Intel HEX形式のメモリイメージである`.mem.hex`ファイルとしてビルトされます。

プロセッサをModelSimでシミュレーションするには、コマンド `do sim.tcl <path to .mem.txt file>` を実行します。

完全な命令トレースを見たい場合は、`do sim.tcl <path to .mem.txt file> TRACE`を実行してください。

RISC-V のテストスイートは、testsディレクトリにあるmakefileでテストをビルドすることで実行できます。
makefileにある`riscv-tests`リポジトリのパスを修正する必要があるかもしれません。

また、マシンモードを無効にしてテストを実行するために必要な 'b' (ベア) テスト環境とカスタムリンカスクリプトも含まれています。

ModelSim を使ってテストを実行するためのスクリプトも提供されています。

- `./tests-all.sh`はすべてのテストを実行します。
- `./tests-all.sh <environment>`は指定した環境ですべてのテストを実行します。たとえば、`./tests-all.sh b`はマシンモードを無効にしてすべてのテストを実行します。
- modelsimの中では、コマンド`do test.tcl <パス先.mem.txtファイル>` で個々のテストを実行できます。

テストはハードウェアでも実行できます。テストがいつ終了し、その結果が何であるかを識別できるように、テスト結果レジスタ(x28)がデバッグポートで公開されています。
